<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Proyecto</title>
    <meta content="" name="description">
    <meta content="" name="keywords">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
    <!-- layaout1 -->
    <link href="static/vendor/animate.css/animate.min.css" rel="stylesheet">
    <link href="static/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="static/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="static/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="static/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
    <link href="static/css/style.css" rel="stylesheet">
    <!-- layaout2 -->
    <link href="../static/vendor/animate.css/animate.min.css" rel="stylesheet">
    <link href="../static/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="../static/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="../static/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="../static/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
    <link href="../static/css/style.css" rel="stylesheet">
    <!-- layaout3 -->
    <link href="../../static/vendor/animate.css/animate.min.css" rel="stylesheet">
    <link href="../../static/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="../../static/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="../../static/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="../../static/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
    <link href="../../static/css/style.css" rel="stylesheet">
</head>
<body>
    <header id="header" class="fixed-top d-flex align-items-center">
        <div class="container d-flex align-items-center">
            <nav id="navbar" class="navbar">
                <ul>
                    {% if current_user.is_authenticated and current_user.id == 1%}
                    <li><a href="{{ url_for('productos.galeria') }}">Productos</a></li>
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.id == 1%}
                    <li><a href="{{ url_for('productos.listaProductos') }}">Lista de Productos</a></li>
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.id == 1%}
                    <li><a href="{{ url_for('materiaPrima.galeriaMateriaPrima') }}">Materia Prima</a></li>
                    {% endif %}
                    <li><a href="{{ url_for('main.contacto') }}">Contacto</a></li>
                    {% if not current_user.is_authenticated %}
                    <li><a href="{{ url_for('auth.login') }}">Acceder</a></li>
                    <li><a href="{{ url_for('auth.register') }}">Registro</a></li>
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.id == 1 or current_user.id == 2 or current_user.id == 4 %}
                    <li><a href="{{ url_for('pedidos.verPedidos') }}">Mis Pedidos</a></li>
                    {% endif %}
                    {% if current_user.is_authenticated %}
                    <li><a href="{{ url_for('auth.logout') }}">Salir</a></li>
                    {% endif %}
                </ul>
                <i class="bi bi-list mobile-nav-toggle"></i>
            </nav>
        </div>
    </header>
    {% block content %}
    {% endblock %}
    <footer id="footer">
        <div class="footer-top">
            <div class="container">
                <div class="row">
                    <div class="col-lg-4 col-md-6">
                        <div class="footer-info">
                            <h3>Proyecto</h3>
                            <p>
                                Granja eva 114<br>
                                Granjeno Plus (IVEEG)<br>
                                37570 León, Gto<br><br>
                                <strong>Telefono:</strong>477 641 92 98<br>
                                <strong>Correo:</strong> angro1212@gmail.com<br>
                            </p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6 footer-links">
                        <h4>Enlaces</h4>
                        <ul>
                            {% if current_user.is_authenticated%}
                            <li><a href="{{ url_for('productos.galeria') }}">Productos</a></li>
                            {% endif %}
                            {% if current_user.is_authenticated and current_user.id == 1%}
                            <li><a href="{{ url_for('productos.listaProductos') }}">Lista de Productos</a></li>
                            {% endif %}
                            <li><a href="{{ url_for('main.contacto') }}">Contacto</a></li>
                            {% if not current_user.is_authenticated %}
                            <li><a href="{{ url_for('auth.login') }}">Acceder</a></li>
                            <li><a href="{{ url_for('auth.register') }}">Registro</a></li>
                            {% endif %}
                            {% if current_user.is_authenticated %}
                            <li><a href="{{ url_for('auth.logout') }}">Salir</a></li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-lg-4 col-md-6 footer-links">
                        <h4>Nuestras redes sociales</h4>
                        <div class="social-links mt-3">
                            <a href="#" class="twitter"><i class="bx bxl-twitter"></i></a>
                            <a href="#" class="facebook"><i class="bx bxl-facebook"></i></a>
                            <a href="#" class="instagram"><i class="bx bxl-instagram"></i></a>
                            <a href="#" class="google-plus"><i class="bx bxl-skype"></i></a>
                            <a href="#" class="linkedin"><i class="bx bxl-linkedin"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="copyright">
                &copy; Copyright <strong><span>Proyecto</span></strong>. Todos los derechos reservados
            </div>
            <div class="credits">
            </div>
        </div>
    </footer>
    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>
    <script src="static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="static/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="static/vendor/isotope-layout/isotope.pkgd.min.js"></script>
    <script src="static/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="static/vendor/waypoints/noframework.waypoints.js"></script>
    <script src="static/vendor/php-email-form/validate.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.5.0/annyang.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.11.3/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>


    <script>
            // Función para construir la tabla HTML con los detalles de los productos en el carrito
            function construirTablaCarrito() {
                var tabla = "<table class='table'>";
                tabla += "<thead><tr><th>Producto</th><th>Precio</th><th>Cantidad</th><th>Acciones</th></tr></thead>";
                tabla += "<tbody>";
            
                for (var idProducto in carrito) {
                    var producto = carrito[idProducto];
                    tabla += "<tr class='producto-row'>";
                    tabla += "<td>" + producto.nombre + "</td>";
                    tabla += "<td class='costo' data-precio='" + producto.precio.toFixed(2) + "'>$" + producto.precio.toFixed(2) + "</td>";
                    tabla += "<td><input type='number' class='cantidad' min='1' max='1000' oninput='this.value=this.value.replace(/[^0-9]/g,\"\")' value='" + producto.cantidad + "'></input></td>";
                    tabla += "<td><button class='btn btn-danger' value='" + idProducto + "'>Eliminar</button></td>";
                    tabla += "</tr>";
                }
            
                tabla += "</tbody></table>";
            
                return tabla;
            }
            // Función para reiniciar el carrito
            function reiniciarCarrito() {
                carrito = {};
                numProductos = 0;
                $("#numProductos").text(numProductos);
            }
            var carrito = {};  // Inicializamos el objeto que representa nuestro carrito de compras
            var numProductos = 0;  // Inicializamos el número de productos en el carrito a cero
       

            // Función para actualizar la tabla del carrito
            function actualizarTablaCarrito() {
                var tabla = construirTablaCarrito();
                $("#tablaCarrito").html(tabla);
            }    

            // Función para eliminar un producto del carrito
            function eliminarProductoCarrito(idProducto) {
                delete carrito[idProducto];
                var tabla = construirTablaCarrito();
                $("#carritoBody").html(tabla);
                actualizarSubtotal();
              }

            function calcularSubtotal() {
                var subtotal = 0;
                $("#carritoBody tr").each(function() {
                  var cantidad = parseInt($(this).find(".cantidad").val());
                  var costo = parseFloat($(this).find(".costo").data("precio"));
                  if (!isNaN(cantidad) && !isNaN(costo)) {
                    var productoSubtotal = cantidad * costo;
                    subtotal += productoSubtotal;
                  }
                });
                return subtotal;
              }
              
              // Función para actualizar el valor del input subtotal en tiempo real
              function actualizarSubtotal() {
                var subtotal = calcularSubtotal();
                $("#subtotal").val(subtotal.toFixed(2));
              }
            // Función para agregar eventos al modal
                function agregarEventosModalCarrito() {
                    // Actualizar el subtotal cada vez que se muestre el modal
                    $('#modalCarrito').on('show.bs.modal', function() {
                    var tabla = construirTablaCarrito();
                    $("#carritoBody").html(tabla);
                    actualizarSubtotal();
                    });
                    // Actualizar el subtotal cada vez que se oculte el modal
                    $('#modalCarrito').on('hidden.bs.modal', function() {
                    actualizarSubtotal();
                    });
                    // Actualizar el subtotal cada vez que se cambie la cantidad de un producto
                    $(document).on("change", "#tablaCarrito input[type='number']", function() {
                    actualizarSubtotal();
                    });
                }
            
              
//-------------------------------------------------------------------------------------------------------------------------------------
//------------------------------------------------------------inicio document ready----------------------------------------------------
//-------------------------------------------------------------------------------------------------------------------------------------       
$(document).ready(function(){
            let table = new DataTable('#myTable', {
                searching: true,
                paging: true,
                ordering: true,
                language: {
                url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json'
                }
            });
            //---------------------------------------------jquery carrito----------------------------------------------------
            agregarEventosModalCarrito();
            $('#ventanaCarrito').on('click',function(){
                actualizarSubtotal();
                $('#modalCarrito').modal();
            });

            $(document).on("change", "#tablaCarrito input[type='number']", function() {
                var idProducto = $(this).closest("tr").data("id");
                var nuevaCantidad = parseInt($(this).val());
              
                if (carrito[idProducto]) {
                  carrito[idProducto].cantidad = nuevaCantidad;
                  actualizarTablaCarrito();
                }
              });
            // Función que se llama cuando se hace clic en el botón "Agregar al carrito"
            $(".agregar-carrito").click(function() {
                var idProducto = $(this).val();  // Obtenemos el ID del producto que se está agregando
                var nombre = $(this).closest(".product-card").find(".card-title").text();  // Obtenemos el nombre del producto
                var precio = $(this).closest(".product-card").find(".card-text").text();  // Obtenemos el precio del producto
                precio = parseFloat(precio.replace("$", ""));  // Convertimos el precio a un número


                // Si el producto ya está en el carrito, incrementamos la cantidad en 1. Si no, lo agregamos al carrito.
                
                    carrito[idProducto] = {
                        nombre: nombre,
                        precio: precio,
                        cantidad: 1
                    };
                
                
                numProductos++;  // Incrementamos el número de productos en el carrito
                
                // Actualizamos el número que se muestra en el botón "Carrito"
                $("#numProductos").text(numProductos);
            });

            // Actualizamos el contenido del modal cada vez que se muestra
                $('#modalCarrito').on('show.bs.modal', function() {
                    var tabla = construirTablaCarrito();
                    var tabla2 = actualizarSubtotal();
                    $("#carritoBody").html(tabla,tabla2);
                });
            // Asignar evento de clic para los botones de eliminar
                $(document).on("click", ".btn-danger", function(event) {
                    var idProducto = $(this).val();
                    eliminarProductoCarrito(idProducto);
                });

            // Función que se llama cuando se hace clic en el botón "Comprar"
            $("#modalCarrito .btn-success").click(function() {
                reiniciarCarrito();
                $("#tablaCarrito").html("<p>Tu carrito está vacío.</p>");
            });

            // Función que se llama cuando se hace clic en el botón "Comprar"
            $("#modalCarrito .btn-success").click(function() {
                reiniciarCarrito();
                $("#tablaCarrito").html("<p>Tu carrito está vacío.</p>");

            });
            //subtotal
            $(document).on("change", ".table", function() {
                actualizarSubtotal();
              });

              

              var productos = [];

              $('#comprarBtn').click(function(event) {
                // Evitar que la página se recargue
                event.preventDefault();
                var productos = [];
                $(".producto-row").each(function(event) {
                  var id = $(this).find(".btn-danger").val();
                  var cantidad = $(this).find(".cantidad").val();
                  var precio = $(this).find(".costo").data("precio");
                  var total = cantidad * precio;
                  productos.push({id: id, cantidad: cantidad, precio: precio, total: total});
                });
                // Obtener el subtotal
                var subtotal = productos.reduce(function(total, producto) {
                  return total + producto.total;
                }, 0);
                // Convertir los datos a una cadena JSON
                var data = JSON.stringify({
                  productos: productos,
                  subtotal: subtotal
                });
                // Enviar la solicitud AJAX
                console.log(data);
                $.ajax({
                  type: "POST",
                  url: "/pedidos/crear_pedido",
                  data: data,
                  contentType: 'application/json;charset=UTF-8',
                  success: function(response) {
                    // Manejar la respuesta del servidor
                    console.log(response);
                  },
                  error: function(error) {
                    // Manejar el error
                    console.log(error);
                  }
                });
              });



              
            //fin docuemntready
        })
    </script>
</body>
</html>